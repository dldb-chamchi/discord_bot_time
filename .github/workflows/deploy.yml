name: Deploy Bot

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            # 1. 에러 발생 시 즉시 중단
            set -e

            cd discord-bot-time/

            # [안전한 해결책] 
            # 문제가 된 'redeploy.sh' 파일만 콕 집어서 깃허브 상태로 되돌립니다.
            # 다른 데이터 파일(json 등)은 건드리지 않으므로 안전합니다!
            git checkout redeploy.sh

            # 2. 최신 코드 받기
            git pull origin main

            # 3. 실행 권한 다시 부여
            chmod +x redeploy.sh

            # 4. 배포 스크립트 실행
            ./redeploy.sh
